- hosts: pi
  become: true
  roles:
    - role: geerlingguy.pip
      tags: [base, deps]
      vars:
        pip_install_packages:
          - name: docker

    - role: geerlingguy.docker
      tags: [base, deps]
      vars:
        docker_users:
          - "{{ ansible_user }}"

    - role: geerlingguy.node_exporter
      tags: [base, node-exporter]
      vars:
        node_exporter_arch_map:
          armv7l: armv7
          aarch64: arm64
        node_exporter_arch: "{{ node_exporter_arch_map[ansible_architecture] }}"

    - role: cockpit
      tags: [base, mgmt-tools, cockpit]

- hosts: pi01
  roles:
    - role: adguardhome
      tags: adguardhome
      vars:
        adguardhome_username: "{{ secrets.adguardhome_username }}"
        adguardhome_password: "{{ secrets.adguardhome_password }}"

    - role: monitoring-server
      tags: monitoring
      vars:
        monitoring_home_assistant_token: "{{ secrets.home_assistant_token }}"
        monitoring_hostname: pi01.lan
        monitoring_prometheus_targets:
          - pi01.lan:9100
          - pi02.lan:9100
          - hass.lan:9100

    - role: wireguard-vpn
      tags: wireguard
      vars:
        wg_external_host: "{{ lan_external_domain }}"
        wg_external_port: "{{ secrets.wireguard_external_port }}"
        wg_default_dns: "{{ lan_dns_servers }}"
        wg_admin_password: "{{ secrets.wireguard_admin_password }}"
        wg_allowed_ips:
          - "{{ lan_network }}"

    - role: nginx
      tags: nginx

    - role: plex
      tags: plex

    - role: upsnap
      tags: upsnap
